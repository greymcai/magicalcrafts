<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Magical Crafts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rose-gold': '#B76E79',
                        'blush-pink': '#F7D7D7',
                        'deep-brown': '#5A3B3B',
                    },
                    fontFamily: {
                        'playfair': ['Playfair Display', 'serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #B76E79;
        }
    </style>
</head>
<body class="bg-blush-pink text-deep-brown min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <a href="index.html" class="text-2xl font-bold text-rose-gold font-playfair block text-center mb-4">Magical Crafts</a>
            <h1 class="text-3xl md:text-4xl font-bold text-center font-playfair">Checkout</h1>
        </header>

        <div id="checkout-content">
            <!-- Content will be dynamically populated -->
        </div>

        <!-- Footer -->
        <footer class="mt-16 pt-8 border-t border-rose-gold text-center">
            <p>&copy; <span id="year"></span> Magical Crafts. All rights reserved. <br>Developed by <a href="https://www.greymc.co.za" target="_blank" class="text-rose-gold hover:underline">www.greymc.co.za</a></p>
        </footer>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();
        
        // Set current year in footer
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Generate payment reference
        function generatePaymentReference() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            return `MC-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
        }
        
        // Load cart and render checkout
        function loadCheckout() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const checkoutContent = document.getElementById('checkout-content');
            const paymentReference = generatePaymentReference();
            
            if (cart.length === 0) {
                checkoutContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md mx-auto">
                        <i data-feather="shopping-cart" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold mb-4 font-playfair">Your cart is empty</h2>
                        <p class="mb-6 text-gray-600">Add some magical products to your cart before proceeding to checkout.</p>
                        <a href="index.html" class="bg-rose-gold hover:bg-deep-brown text-white px-6 py-3 rounded-full transition duration-300 font-medium">
                            Back to Shop
                        </a>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            // Calculate totals
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            const shipping = 50;
            const total = subtotal + shipping;
            
            // Create order details text
            const orderDetails = cart.map(item => 
                `${item.name} (${item.quantity} x R ${item.price.toFixed(2)}) - R ${(item.price * item.quantity).toFixed(2)}`
            ).join('\n');
            
            const fullOrderDetails = JSON.stringify({
                items: cart,
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                reference: paymentReference
            }, null, 2);
            
            checkoutContent.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-8 mb-8">
                    <!-- Order Summary -->
                    <div class="lg:w-2/5">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold font-playfair">Order Summary</h2>
                                <a href="edit-cart.html" class="text-rose-gold hover:text-deep-brown flex items-center text-sm">
                                    <i data-feather="edit" class="w-4 h-4 mr-1"></i> Edit Cart
                                </a>
                            </div>
                            
                            <div id="checkout-items" class="space-y-4 mb-6">
                                ${cart.map(item => `
                                    <div class="flex justify-between items-center border-b border-gray-100 pb-4">
                                        <div>
                                            <h4 class="font-medium">${item.name}</h4>
                                            <p class="text-sm text-gray-500">R ${item.price.toFixed(2)} × ${item.quantity}</p>
                                        </div>
                                        <span>R ${(item.price * item.quantity).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between mb-2">
                                    <span>Subtotal</span>
                                    <span>R ${subtotal.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span>Shipping</span>
                                    <span>R ${shipping.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Total</span>
                                    <span>R ${total.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Checkout Form -->
                    <div class="lg:w-3/5">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-xl font-bold mb-6 font-playfair">Shipping Details</h2>
                            
                            <form id="checkout-form" action="https://formsubmit.co/hello@greymc.co.za" method="POST" class="space-y-4">
                                <input type="hidden" name="_subject" value="New Order - ${paymentReference}">
                                <input type="hidden" name="_next" value="thank-you.html">
                                <input type="hidden" name="_captcha" value="false">
                                <input type="hidden" name="_template" value="html">
                                <input type="hidden" name="_cc" value="hello@greymc.co.za">
                                <input type="hidden" name="_replyto" id="reply-to-email">
                                
                                <input type="hidden" name="order_reference" value="${paymentReference}">
                                <textarea name="order_details" class="hidden">${fullOrderDetails}</textarea>
                                <input type="hidden" name="customer_email" id="customer-email-input">
                                <input type="hidden" name="payment_instructions" id="payment-instructions">
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="full-name" class="block mb-1">Full Name *</label>
                                        <input type="text" id="full-name" name="full_name" required 
                                               class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                                    </div>
                                    
                                    <div>
                                        <label for="email" class="block mb-1">Email *</label>
                                        <input type="email" id="email" name="email" required 
                                               class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="phone" class="block mb-1">Phone *</label>
                                        <input type="tel" id="phone" name="phone" required 
                                               class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                                    </div>
                                    
                                    <div>
                                        <label for="address" class="block mb-1">Delivery Address *</label>
                                        <textarea id="address" name="address" rows="1" required 
                                                  class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold"></textarea>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="order-notes" class="block mb-1">Order Notes</label>
                                    <textarea id="order-notes" name="order_notes" rows="3" 
                                              class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold" 
                                              placeholder="Any special instructions or delivery notes..."></textarea>
                                </div>
                                
                                <div class="pt-6">
                                    <h3 class="text-lg font-bold mb-4 font-playfair">Payment Information</h3>
                                    <div class="bg-blush-pink p-4 rounded-lg">
                                        <h4 class="font-bold mb-3">Bank Transfer Details</h4>
                                        <div class="space-y-2 text-sm">
                                            <p><span class="font-medium">Bank:</span> [Replace with Bank Name]</p>
                                            <p><span class="font-medium">Account Name:</span> Magical Crafts</p>
                                            <p><span class="font-medium">Account Number:</span> [Replace with Account Number]</p>
                                            <p><span class="font-medium">Branch Code:</span> [Replace with Branch Code]</p>
                                            <p><span class="font-medium">SWIFT Code:</span> [Replace with SWIFT Code]</p>
                                            <p class="font-bold mt-3"><span class="font-medium">Reference:</span> ${paymentReference}</p>
                                        </div>
                                        <p class="text-sm mt-3 text-deep-brown/80">Please use the exact reference number above when making your payment.</p>
                                    </div>
                                </div>
                                
                                <div class="pt-6 space-y-4">
                                    <button type="button" onclick="downloadPaymentInstructions()" class="w-full bg-blush-pink hover:bg-rose-gold text-deep-brown hover:text-white py-3 rounded-full transition duration-300 font-medium border border-rose-gold">
                                        Download Payment Instructions
                                    </button>
                                    <button type="button" onclick="emailPaymentInstructions()" class="w-full bg-blush-pink hover:bg-rose-gold text-deep-brown hover:text-white py-3 rounded-full transition duration-300 font-medium border border-rose-gold">
                                        Email Payment Instructions
                                    </button>
                                    <button type="submit" class="w-full bg-rose-gold hover:bg-deep-brown text-white py-3 rounded-full transition duration-300 font-medium">
                                        Confirm Order
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Order Confirmation Section (initially hidden) -->
                <div id="order-confirmation" class="hidden bg-white rounded-lg shadow-lg p-8 text-center max-w-2xl mx-auto">
                    <div class="mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    
                    <h2 class="text-2xl font-bold mb-4 font-playfair">Order Confirmed!</h2>
                    <p class="mb-6">Thank you for your order. We've sent a confirmation email with your order details.</p>
                    
                    <div class="bg-blush-pink rounded-lg p-6 mb-6 text-left">
                        <h3 class="text-lg font-bold mb-3 font-playfair">Payment Instructions</h3>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">Reference Number:</span> <span class="font-mono">${paymentReference}</span></p>
                            <p><span class="font-medium">Bank:</span> [Replace with Bank Name]</p>
                            <p><span class="font-medium">Account Name:</span> Magical Crafts</p>
                            <p><span class="font-medium">Account Number:</span> [Replace with Account Number]</p>
                            <p><span class="font-medium">Amount Due:</span> R ${total.toFixed(2)}</p>
                        </div>
                        <p class="mt-3 text-sm text-deep-brown/80">Please complete your payment within 24 hours to secure your order.</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button type="button" onclick="emailPaymentInstructions()" class="w-full bg-blush-pink hover:bg-rose-gold text-deep-brown hover:text-white py-3 rounded-full transition duration-300 font-medium border border-rose-gold">
                            Email Payment Instructions
                        </button>
                        <a href="index.html" class="block w-full bg-rose-gold hover:bg-deep-brown text-white py-3 rounded-full transition duration-300 font-medium text-center">
                            Continue Shopping
                        </a>
                    </div>
                </div>
            `;
            
            feather.replace();
            
            // Handle form submission
            const form = document.getElementById('checkout-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Stop the form from submitting
                
                // Get form data
                const customerEmail = document.getElementById('email').value;
                const customerName = document.getElementById('full-name').value;
                const paymentReference = generatePaymentReference();
                
                // Set hidden form fields
                document.getElementById('reply-to-email').value = customerEmail;
                document.getElementById('customer-email-input').value = customerEmail;
                
                // Generate and set payment instructions
                const paymentInstructions = generatePaymentInstructionsText();
                document.getElementById('payment-instructions').value = paymentInstructions;
                
                // Send email automatically
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                emailPaymentInstructions(customerEmail, customerName, paymentReference, cart);
                
                // Show confirmation section
                document.getElementById('order-confirmation').classList.remove('hidden');
                document.querySelector('.flex.flex-col.lg\\:flex-row.gap-8.mb-8').classList.add('hidden');
                
                // Scroll to confirmation
                document.getElementById('order-confirmation').scrollIntoView({ behavior: 'smooth' });
                
                // Clear cart
                localStorage.removeItem('cart');
            });
        }
        
        // Initialize on page load
        loadCheckout();

        // Function to email payment instructions
        function emailPaymentInstructions(customerEmail, customerName, paymentReference, cart) {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            const shipping = 50;
            const total = subtotal + shipping;

            // --- Plain Text Email Content ---
            const plainTextContent = `
Payment Instructions - Magical Crafts

Dear ${customerName},

Thank you for your order with Magical Crafts! Here are your payment instructions:

ORDER SUMMARY:
${cart.map(item => `${item.name} × ${item.quantity} - R ${(item.price * item.quantity).toFixed(2)}`).join('\n')}

Subtotal: R ${subtotal.toFixed(2)}
Shipping: R ${shipping.toFixed(2)}
Total: R ${total.toFixed(2)}

BANK TRANSFER DETAILS:
Bank: [Replace with Bank Name]
Account Name: Magical Crafts
Account Number: [Replace with Account Number]
Branch Code: [Replace with Branch Code]
SWIFT Code: [Replace with SWIFT Code]
Reference: ${paymentReference}

Please use the exact reference number above when making your payment.
Payment must be completed within 24 hours to secure your order.

Thank you for choosing Magical Crafts!

Best regards,
The Magical Crafts Team

Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
            `;

            // --- Submit via FormSubmit ---
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://formsubmit.co/hello@greymc.co.za';

            const addHidden = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            addHidden('_subject', `Payment Instructions - ${paymentReference}`);
            addHidden('_cc', customerEmail); // Send copy to customer
            addHidden('_replyto', customerEmail);
            addHidden('customer_name', customerName);
            addHidden('customer_email', customerEmail);
            addHidden('message', plainTextContent);

            document.body.appendChild(form);
            form.submit();

            // Show thank you message
            document.getElementById('thank-you-message').classList.remove('hidden');
            document.getElementById('thank-you-message').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to generate payment instructions text
        function generatePaymentInstructionsText() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) return '';
            
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            const shipping = 50;
            const total = subtotal + shipping;
            const paymentReference = generatePaymentReference();
            
            return `
ORDER SUMMARY:
${cart.map(item => `${item.name} × ${item.quantity} - R ${(item.price * item.quantity).toFixed(2)}`).join('\n')}

Subtotal: R ${subtotal.toFixed(2)}
Shipping: R ${shipping.toFixed(2)}
Total: R ${total.toFixed(2)}

BANK TRANSFER DETAILS:
Bank: [Replace with Bank Name]
Account Name: Magical Crafts
Account Number: [Replace with Account Number]
Branch Code: [Replace with Branch Code]
SWIFT Code: [Replace with SWIFT Code]
Reference: ${paymentReference}

Please use the exact reference number above when making your payment.
Payment must be completed within 24 hours to secure your order.
            `;
        }


        // Function to download payment instructions as HTML
        function downloadPaymentInstructions() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) return;
            
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            const shipping = 50;
            const total = subtotal + shipping;
            
            const paymentReference = generatePaymentReference();
            
            // Create HTML content for the PDF
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Payment Instructions - Magical Crafts</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .logo { color: #B76E79; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .section { margin-bottom: 20px; }
                        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #5A3B3B; }
                        .payment-details { background: #F7D7D7; padding: 20px; border-radius: 8px; }
                        .reference { font-family: monospace; font-size: 16px; background: #fff; padding: 8px; border-radius: 4px; }
                        .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">Magical Crafts</div>
                        <h1>Payment Instructions</h1>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Order Summary</div>
                        ${cart.map(item => `
                            <div>${item.name} × ${item.quantity} - R ${(item.price * item.quantity).toFixed(2)}</div>
                        `).join('')}
                        <div style="margin-top: 10px;">
                            <div>Subtotal: R ${subtotal.toFixed(2)}</div>
                            <div>Shipping: R ${shipping.toFixed(2)}</div>
                            <div style="font-weight: bold; margin-top: 5px;">Total: R ${total.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Bank Transfer Details</div>
                        <div class="payment-details">
                            <p><strong>Bank:</strong> [Replace with Bank Name]</p>
                            <p><strong>Account Name:</strong> Magical Crafts</p>
                            <p><strong>Account Number:</strong> [Replace with Account Number]</p>
                            <p><strong>Branch Code:</strong> [Replace with Branch Code]</p>
                            <p><strong>SWIFT Code:</strong> [Replace with SWIFT Code]</p>
                            <p style="margin-top: 15px;"><strong>Reference Number:</strong></p>
                            <div class="reference">${paymentReference}</div>
                            <p style="margin-top: 15px; font-style: italic;">
                                Please use the exact reference number above when making your payment.
                                Payment must be completed within 24 hours to secure your order.
                            </p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                        <p>Magical Crafts - Handcrafted Luxury Scents</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create a Blob and download link
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payment-instructions-${paymentReference}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
