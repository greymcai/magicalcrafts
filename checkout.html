<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Magical Crafts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rose-gold': '#B76E79',
            'blush-pink': '#F7D7D7',
            'deep-brown': '#5A3B3B',
          },
          fontFamily: {
            'playfair': ['Playfair Display', 'serif'],
            'poppins': ['Poppins', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
    input:focus, textarea:focus { outline: none; border-color: #B76E79; }
  </style>
</head>
<body class="bg-blush-pink text-deep-brown min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="mb-8">
      <a href="index.html" class="text-2xl font-bold text-rose-gold font-playfair block text-center mb-4">Magical Crafts</a>
      <h1 class="text-3xl md:text-4xl font-bold text-center font-playfair">Checkout</h1>
    </header>

    <div id="checkout-content"></div>

    <footer class="mt-16 pt-8 border-t border-rose-gold text-center">
      <p>&copy; <span id="year"></span> Magical Crafts. All rights reserved. <br>Developed by <a href="https://www.greymc.co.za" target="_blank" class="text-rose-gold hover:underline">www.greymc.co.za</a></p>
    </footer>
  </div>

  <script>
    feather.replace();
    document.getElementById('year').textContent = new Date().getFullYear();

    function generatePaymentReference() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `MC-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
    }

    function loadCheckout() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const checkoutContent = document.getElementById('checkout-content');
      const paymentReference = generatePaymentReference();

      if (cart.length === 0) {
        checkoutContent.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md mx-auto">
            <i data-feather="shopping-cart" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold mb-4 font-playfair">Your cart is empty</h2>
            <p class="mb-6 text-gray-600">Add some magical products to your cart before proceeding to checkout.</p>
            <a href="index.html" class="bg-rose-gold hover:bg-deep-brown text-white px-6 py-3 rounded-full transition duration-300 font-medium">
              Back to Shop
            </a>
          </div>
        `;
        feather.replace();
        return;
      }

      let subtotal = 0;
      cart.forEach(item => { subtotal += item.price * item.quantity; });
      const shipping = 50;
      const total = subtotal + shipping;

      const fullOrderDetails = JSON.stringify({
        items: cart,
        subtotal: subtotal,
        shipping: shipping,
        total: total,
        reference: paymentReference
      }, null, 2);

      checkoutContent.innerHTML = `
        <div class="flex flex-col lg:flex-row gap-8 mb-8">
          <div class="lg:w-2/5">
            <div class="bg-white rounded-lg shadow-lg p-6">
              <h2 class="text-xl font-bold font-playfair mb-4">Order Summary</h2>
              ${cart.map(item => `
                <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-4">
                  <div>
                    <h4 class="font-medium">${item.name}</h4>
                    <p class="text-sm text-gray-500">R ${item.price.toFixed(2)} Ã— ${item.quantity}</p>
                  </div>
                  <span>R ${(item.price * item.quantity).toFixed(2)}</span>
                </div>
              `).join('')}
              <div class="border-t border-gray-200 pt-4">
                <div class="flex justify-between mb-2"><span>Subtotal</span><span>R ${subtotal.toFixed(2)}</span></div>
                <div class="flex justify-between mb-2"><span>Shipping</span><span>R ${shipping.toFixed(2)}</span></div>
                <div class="flex justify-between font-bold text-lg"><span>Total</span><span>R ${total.toFixed(2)}</span></div>
              </div>
            </div>
          </div>

          <div class="lg:w-3/5">
            <div class="bg-white rounded-lg shadow-lg p-6">
              <h2 class="text-xl font-bold mb-6 font-playfair">Shipping Details</h2>
              <form id="checkout-form" class="space-y-4">
                <input type="hidden" name="_subject" value="New Order - ${paymentReference}">
                <input type="hidden" name="_captcha" value="false">
                <input type="hidden" name="_cc" value="hello@greymc.co.za">
                <textarea name="order_details" class="hidden" id="order-details">${fullOrderDetails}</textarea>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="full-name" class="block mb-1">Full Name *</label>
                    <input type="text" id="full-name" name="full_name" required class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                  </div>
                  <div>
                    <label for="email" class="block mb-1">Email *</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="phone" class="block mb-1">Phone *</label>
                    <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold">
                  </div>
                  <div>
                    <label for="address" class="block mb-1">Delivery Address *</label>
                    <textarea id="address" name="address" rows="1" required class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold"></textarea>
                  </div>
                </div>

                <div>
                  <label for="order-notes" class="block mb-1">Order Notes</label>
                  <textarea id="order-notes" name="order_notes" rows="3" class="w-full px-4 py-2 rounded bg-white text-deep-brown border border-gray-300 focus:border-rose-gold" placeholder="Any special instructions or delivery notes..."></textarea>
                </div>

                <div class="pt-6">
                  <h3 class="text-lg font-bold mb-4 font-playfair">Payment Information</h3>
                  <div class="bg-blush-pink p-4 rounded-lg">
                    <h4 class="font-bold mb-3">Bank Transfer Details</h4>
                    <div class="space-y-2 text-sm">
                      <p><span class="font-medium">Bank:</span> [Replace with Bank Name]</p>
                      <p><span class="font-medium">Account Name:</span> Magical Crafts</p>
                      <p><span class="font-medium">Account Number:</span> [Replace with Account Number]</p>
                      <p><span class="font-medium">Branch Code:</span> [Replace with Branch Code]</p>
                      <p><span class="font-medium">SWIFT Code:</span> [Replace with SWIFT Code]</p>
                      <p class="font-bold mt-3"><span class="font-medium">Reference:</span> ${paymentReference}</p>
                    </div>
                    <p class="text-sm mt-3 text-deep-brown/80">Please use the exact reference number above when making your payment.</p>
                  </div>
                </div>

                <div class="pt-6 space-y-4">
                  <button type="submit" class="w-full bg-rose-gold hover:bg-deep-brown text-white py-3 rounded-full transition duration-300 font-medium">Confirm Order</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      feather.replace();

      // JS submit handler (fetch to FormSubmit with redirect)
      document.getElementById('checkout-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        // Send to FormSubmit invisibly
        fetch('https://formsubmit.co/hello@greymc.co.za', {
          method: 'POST',
          body: formData,
        })
        .then(response => {
          if (response.ok) {
            // Clear cart and redirect to thank-you page
            localStorage.removeItem('cart');
            window.location.href = 'thank-you.html';
          } else {
            alert('Error sending order. Please try again.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error sending order. Please try again.');
        });
      });
    }

    loadCheckout();
  </script>
</body>
</html>
